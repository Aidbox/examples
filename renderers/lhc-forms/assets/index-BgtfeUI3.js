(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const d of o.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&t(d)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function t(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();const a=document.getElementById("root"),L=new URLSearchParams(window.location.search),g=L.get("messaging_handle"),m=L.get("messaging_origin"),f=window.opener||window.parent;let c=null,l=null,F=null,R=null;function u(s){if(!a)return;a.innerHTML="";const e=document.createElement("div");e.style.fontFamily="system-ui, -apple-system, sans-serif",e.style.padding="8px",e.style.color="#b42318",e.textContent=s,a.appendChild(e)}function H(){return Math.random().toString(36).slice(2,10)}function w(s){!f||!m||f.postMessage(s,m)}function Q(s,e,n){const t=e.messageType||"response",r=e.messageId||"-",o=e.responseToMessageId||"-",d=e.messagingHandle||"-";if(n===void 0){console.log(`[${s}] type=${t} id=${r} respTo=${o} handle=${d}`);return}console.log(`[${s}] type=${t} id=${r} respTo=${o} handle=${d}`,n)}function C(s,e){const n={messagingHandle:g,messageId:H(),messageType:s,payload:e};Q("out",n,e),w(n)}function p(s,e,n){const t={messagingHandle:g,messageId:H(),messageType:s,responseToMessageId:e,payload:n};Q("out",t,n),w(t)}function T(s,e,n){return{resourceType:"OperationOutcome",issue:[{severity:s,code:e,diagnostics:n}]}}function i(s,e,n,t){const r={status:n};t&&(r.outcome=T("error","invalid",t)),p(s,e,r)}function y(){return window.LForms&&window.LForms.Util?window.LForms.Util:null}function M(){a&&(a.innerHTML="")}function v(s){const e=y();return e&&typeof e.convertFHIRQuestionnaireToLForms=="function"?e.convertFHIRQuestionnaireToLForms(s):s}function b(s,e){const n=y();return!n||!e?s:typeof n.mergeFHIRQuestionnaireResponse=="function"?n.mergeFHIRQuestionnaireResponse(s,e):typeof n.mergeFHIRDataIntoLForms=="function"?n.mergeFHIRDataIntoLForms(s,e):(typeof n.setFHIRQuestionnaireResponse=="function"&&n.setFHIRQuestionnaireResponse(e),s)}function I(s,e){const n=y();if(!n||!a)return!1;const t=v(s),r=b(t,e);if(M(),typeof n.addFormToPage=="function"){const o=a.id||"root";return n.addFormToPage(r,o),!0}return!1}function q(){const s=y();return s?typeof s.getFormFHIRData=="function"?s.getFormFHIRData("QuestionnaireResponse","R4"):typeof s.getFormData=="function"?s.getFormData():null:null}function h(){F&&(R&&clearTimeout(R),R=setTimeout(()=>{const s=q();s&&F(s)},50))}function E(){a&&(a.addEventListener("change",h,!0),a.addEventListener("input",h,!0))}if(!g||!m)throw u("Missing SDC SWM parameters."),new Error("Missing SDC SWM parameters");F=s=>{l=s,C("sdc.ui.changedQuestionnaireResponse",{questionnaireResponse:s})};E();C("status.handshake",{protocolVersion:"1.0",fhirVersion:"R4"});window.addEventListener("message",s=>{if(!f||s.source!==f||s.origin!==m)return;const e=s.data||{};if(Q("in",e,e.payload),!(e.messagingHandle&&e.messagingHandle!==g)&&e.messageType)switch(e.messageType){case"status.handshake":p("status.handshake",e.messageId,{application:{name:"LHC-Forms",publisher:"NLM Lister Hill National Center for Biomedical Communications"},capabilities:{extraction:!1,focusChangeNotifications:!1}});return;case"sdc.configure":i("sdc.configure",e.messageId,"success");return;case"sdc.configureContext":i("sdc.configureContext",e.messageId,"success");return;case"sdc.displayQuestionnaire":{const n=e.payload&&e.payload.questionnaire?e.payload.questionnaire:e.payload;if(!n||n.resourceType!=="Questionnaire"){i("sdc.displayQuestionnaire",e.messageId,"error","Missing questionnaire in sdc.displayQuestionnaire."),u("Missing questionnaire in sdc.displayQuestionnaire.");return}if(!window.LForms){i("sdc.displayQuestionnaire",e.messageId,"error","LHC-Forms script not loaded."),u("LHC-Forms script not loaded.");return}if(c=n,l=e.payload&&e.payload.questionnaireResponse?e.payload.questionnaireResponse:l,!I(c,l)){i("sdc.displayQuestionnaire",e.messageId,"error","LHC-Forms renderer is not available."),u("LHC-Forms renderer is not available.");return}i("sdc.displayQuestionnaire",e.messageId,"success");return}case"sdc.displayQuestionnaireResponse":{const n=e.payload&&e.payload.questionnaireResponse?e.payload.questionnaireResponse:e.payload;if(!n||n.resourceType!=="QuestionnaireResponse"){i("sdc.displayQuestionnaireResponse",e.messageId,"error","Missing questionnaireResponse in sdc.displayQuestionnaireResponse."),u("Missing questionnaireResponse in sdc.displayQuestionnaireResponse.");return}if(!window.LForms){i("sdc.displayQuestionnaireResponse",e.messageId,"error","LHC-Forms script not loaded."),u("LHC-Forms script not loaded.");return}l=n;const t=e.payload&&e.payload.questionnaire?e.payload.questionnaire:c;if(t&&t.resourceType==="Questionnaire"&&(c=t),!c){i("sdc.displayQuestionnaireResponse",e.messageId,"error","Questionnaire is required to render QuestionnaireResponse."),u("Questionnaire is required to render QuestionnaireResponse.");return}if(!I(c,l)){i("sdc.displayQuestionnaireResponse",e.messageId,"error","LHC-Forms renderer is not available."),u("LHC-Forms renderer is not available.");return}i("sdc.displayQuestionnaireResponse",e.messageId,"success");return}case"sdc.requestCurrentQuestionnaireResponse":{const n=q();if(n){p("sdc.requestCurrentQuestionnaireResponse",e.messageId,{questionnaireResponse:n});return}p("sdc.requestCurrentQuestionnaireResponse",e.messageId,{outcome:T("error","not-found","No QuestionnaireResponse is currently loaded.")});return}case"sdc.requestExtract":p("sdc.requestExtract",e.messageId,{outcome:{resourceType:"OperationOutcome",issue:[{severity:"error",code:"not-supported",diagnostics:"Extract is not implemented in this renderer."}]}});return;default:p(e.messageType||"response",e.messageId,{status:"error",statusDetail:{message:"Unsupported message type"}})}});
