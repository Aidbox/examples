(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))t(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const I of a.addedNodes)I.tagName==="LINK"&&I.rel==="modulepreload"&&t(I)}).observe(document,{childList:!0,subtree:!0});function r(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function t(s){if(s.ep)return;s.ep=!0;const a=r(s);fetch(s.href,a)}})();function O(e){return e&&typeof e.messagingHandle=="string"&&typeof e.messageId=="string"&&typeof e.messageType=="string"&&typeof e.payload=="object"&&!("responseToMessageId"in e)}function P(e){return e&&typeof e.messageId=="string"&&typeof e.responseToMessageId=="string"&&typeof e.payload=="object"}const c=document.getElementById("root"),b=new URLSearchParams(window.location.search),Q=b.get("messaging_handle"),y=b.get("messaging_origin"),R=window.opener||window.parent;let f=null,l=null,C=null,L=null,F=null;function u(e){if(!c)return;c.innerHTML="";const n=document.createElement("div");n.style.fontFamily="system-ui, -apple-system, sans-serif",n.style.padding="8px",n.style.color="#b42318",n.textContent=e,c.appendChild(n)}function M(){return Math.random().toString(36).slice(2,10)}function E(e){!R||!y||R.postMessage(e,y)}const j=["status.handshake","sdc.configure","sdc.configureContext","sdc.displayQuestionnaire","sdc.displayQuestionnaireResponse","sdc.requestCurrentQuestionnaireResponse","sdc.requestExtract","sdc.ui.changedQuestionnaireResponse","sdc.ui.changedFocus","ui.done"];function S(e,n){const r={messagingHandle:Q,messageId:M(),messageType:e,payload:n};E(r)}function d(e,n,r){const t={messagingHandle:Q,messageId:M(),messageType:e,responseToMessageId:n,payload:r};E(t)}function g(e,n,r){return{resourceType:"OperationOutcome",issue:[{severity:e,code:n,diagnostics:r}]}}function i(e,n,r,t){const s={status:r};t&&(s.outcome=g("error","invalid",t)),d(e,n,s)}function o(e){return typeof e=="object"&&e!==null}function N(e){return j.includes(e)}function p(e){return o(e)&&e.resourceType==="Questionnaire"}function m(e){return o(e)&&e.resourceType==="QuestionnaireResponse"}function w(e){if(!o(e))return null;if(p(e))return e;const n=e.questionnaire;return p(n)?n:null}function q(e){if(!o(e))return null;if(m(e))return e;const n=e.questionnaireResponse;return m(n)?n:null}function D(e){return!(!o(e)||typeof e.name!="string"||e.contentReference!==void 0&&!o(e.contentReference)||e.contentResource!==void 0&&!o(e.contentResource))}function x(e){return!(!o(e)||e.subject!==void 0&&!o(e.subject)||e.author!==void 0&&!o(e.author)||e.encounter!==void 0&&!o(e.encounter)||e.launchContext!==void 0&&(!Array.isArray(e.launchContext)||!e.launchContext.every(D)))}function A(e){return!(!o(e)||e.terminologyServer!==void 0&&typeof e.terminologyServer!="string"||e.dataServer!==void 0&&typeof e.dataServer!="string"||e.configuration!==void 0&&!o(e.configuration))}function U(e){return!(!o(e)||e.context!==void 0&&!x(e.context))}function W(e){return p(e)?!0:!(!o(e)||e.questionnaire!==void 0&&!p(e.questionnaire)||e.questionnaireResponse!==void 0&&!m(e.questionnaireResponse)||e.context!==void 0&&!x(e.context))}function B(e){return m(e)?!0:!(!o(e)||e.questionnaireResponse!==void 0&&!m(e.questionnaireResponse)||e.questionnaire!==void 0&&!p(e.questionnaire))}function V(e){if(!o(e))return;const n=e.context;return x(n)?n:void 0}function _(e=[],n=[]){const r=new Map;for(const t of e)r.set(t.name,t);for(const t of n)r.set(t.name,t);return Array.from(r.values())}function K(e,n){if(!n)return e;const r={subject:n.subject??e?.subject,author:n.author??e?.author,encounter:n.encounter??e?.encounter},t=_(e?.launchContext??[],n.launchContext??[]);return t.length>0&&(r.launchContext=t),r}function h(){return window.LForms&&window.LForms.Util?window.LForms.Util:null}function z(){c&&(c.innerHTML="")}function G(e){const n=h();return n&&typeof n.convertFHIRQuestionnaireToLForms=="function"?n.convertFHIRQuestionnaireToLForms(e):e}function J(e,n){const r=h();return!r||!n?e:typeof r.mergeFHIRQuestionnaireResponse=="function"?r.mergeFHIRQuestionnaireResponse(e,n):typeof r.mergeFHIRDataIntoLForms=="function"?r.mergeFHIRDataIntoLForms(e,n):(typeof r.setFHIRQuestionnaireResponse=="function"&&r.setFHIRQuestionnaireResponse(n),e)}function H(e,n){const r=h();if(!r||!c)return!1;const t=G(e),s=J(t,n);if(z(),typeof r.addFormToPage=="function"){const a=c.id||"root";return r.addFormToPage(s,a),!0}return!1}function v(){const e=h();return e?typeof e.getFormFHIRData=="function"?e.getFormFHIRData("QuestionnaireResponse","R4"):typeof e.getFormData=="function"?e.getFormData():null:null}function T(){L&&(F&&window.clearTimeout(F),F=window.setTimeout(()=>{const e=v();e&&L(e)},50))}function X(){c&&(c.addEventListener("change",T,!0),c.addEventListener("input",T,!0))}if(!Q||!y)throw u("Missing SDC SWM parameters."),new Error("Missing SDC SWM parameters");L=e=>{l=e,S("sdc.ui.changedQuestionnaireResponse",{questionnaireResponse:e})};X();S("status.handshake",{protocolVersion:"1.0",fhirVersion:"R4"});window.addEventListener("message",e=>{if(!R||e.source!==R||e.origin!==y)return;const n=e.data??{};if(!P(n)&&O(n)&&N(n.messageType)&&!(n.messagingHandle&&n.messagingHandle!==Q))switch(n.messageType){case"status.handshake":d("status.handshake",n.messageId,{application:{name:"LHC-Forms",publisher:"NLM Lister Hill National Center for Biomedical Communications"},capabilities:{extraction:!1,focusChangeNotifications:!1}});return;case"sdc.configure":if(!A(n.payload)){i("sdc.configure",n.messageId,"error","Invalid sdc.configure payload.");return}i("sdc.configure",n.messageId,"success");return;case"sdc.configureContext":{if(!U(n.payload)){i("sdc.configureContext",n.messageId,"error","Invalid sdc.configureContext payload.");return}C=n.payload.context??null,i("sdc.configureContext",n.messageId,"success");return}case"sdc.displayQuestionnaire":{if(!W(n.payload)){i("sdc.displayQuestionnaire",n.messageId,"error","Invalid sdc.displayQuestionnaire payload."),u("Invalid sdc.displayQuestionnaire payload.");return}const r=w(n.payload);if(!r||r.resourceType!=="Questionnaire"){i("sdc.displayQuestionnaire",n.messageId,"error","Missing questionnaire in sdc.displayQuestionnaire."),u("Missing questionnaire in sdc.displayQuestionnaire.");return}if(!window.LForms){i("sdc.displayQuestionnaire",n.messageId,"error","LHC-Forms script not loaded."),u("LHC-Forms script not loaded.");return}C=K(C,V(n.payload)),f=r;const t=q(n.payload);if(t&&(l=t),!H(f,l)){i("sdc.displayQuestionnaire",n.messageId,"error","LHC-Forms renderer is not available."),u("LHC-Forms renderer is not available.");return}i("sdc.displayQuestionnaire",n.messageId,"success");return}case"sdc.displayQuestionnaireResponse":{if(!B(n.payload)){i("sdc.displayQuestionnaireResponse",n.messageId,"error","Invalid sdc.displayQuestionnaireResponse payload."),u("Invalid sdc.displayQuestionnaireResponse payload.");return}const r=q(n.payload);if(!r||r.resourceType!=="QuestionnaireResponse"){i("sdc.displayQuestionnaireResponse",n.messageId,"error","Missing questionnaireResponse in sdc.displayQuestionnaireResponse."),u("Missing questionnaireResponse in sdc.displayQuestionnaireResponse.");return}if(!window.LForms){i("sdc.displayQuestionnaireResponse",n.messageId,"error","LHC-Forms script not loaded."),u("LHC-Forms script not loaded.");return}l=r;const t=w(n.payload)??f;if(t&&t.resourceType==="Questionnaire"&&(f=t),!f){i("sdc.displayQuestionnaireResponse",n.messageId,"error","Questionnaire is required to render QuestionnaireResponse."),u("Questionnaire is required to render QuestionnaireResponse.");return}if(!H(f,l)){i("sdc.displayQuestionnaireResponse",n.messageId,"error","LHC-Forms renderer is not available."),u("LHC-Forms renderer is not available.");return}i("sdc.displayQuestionnaireResponse",n.messageId,"success");return}case"sdc.requestCurrentQuestionnaireResponse":{if(!o(n.payload)){d("sdc.requestCurrentQuestionnaireResponse",n.messageId,{outcome:g("error","invalid","Invalid sdc.requestCurrentQuestionnaireResponse payload.")});return}const r=v();if(r){d("sdc.requestCurrentQuestionnaireResponse",n.messageId,{questionnaireResponse:r});return}d("sdc.requestCurrentQuestionnaireResponse",n.messageId,{outcome:g("error","not-found","No QuestionnaireResponse is currently loaded.")});return}case"sdc.requestExtract":{if(!o(n.payload)){d("sdc.requestExtract",n.messageId,{outcome:g("error","invalid","Invalid sdc.requestExtract payload.")});return}d("sdc.requestExtract",n.messageId,{outcome:{resourceType:"OperationOutcome",issue:[{severity:"error",code:"not-supported",diagnostics:"Extract is not implemented in this renderer."}]}});return}default:return}});
