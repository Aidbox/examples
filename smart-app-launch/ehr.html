<!DOCTYPE html>
<html>
<head>
    <title>FHIR Patient List</title>
</head>
<body>

    <h1>EHR Emulator</h1>

    <div id="patientList">
        <h1>Patient List</h1>
        <div id="user-info"></div>
        <ul id="patients"></ul>
    </div>

    <script>
        // Client credentials
        const client_id = 'ehr';
        const client_secret = 'verysecret';

        // Encode credentials in Base64
        const credentials = btoa(client_id + ':' + client_secret);

        // Headers for Basic Authentication
        const headers = {
            'Authorization': 'Basic ' + credentials
        };

        // Display client ID as user info
        showUserInfo(client_id);

        // FHIR API endpoint
        const fhirUrl = 'http://localhost:8080/fhir/Patient?_count=20&birthdate=ge2000';

        // Fetch patients using Basic Auth
        fetch(fhirUrl, {
            method: 'GET',
            headers: headers
        })
        .then(response => response.json())
        .then(fhirData => {
            displayPatients(fhirData);
        })
        .catch(error => {
            console.error('Error fetching patients:', error);
        });

        function showUserInfo(username) {
            const userInfo = document.getElementById('user-info');
            userInfo.innerHTML = 'Using client ID: ' + username;
        }

        function launch(patientId) {
            const fhirUrl = 'http://localhost:8080/rpc';
            let body = {
                method: "aidbox.smart/get-launch-uri",
                params: {
                    user: "practitioner",
                    iss: "http://localhost:8080/fhir",
                    client: "growth_chart",
                    ctx: { patient: patientId }
                }
            };
            fetch(fhirUrl, {
                method: 'POST',
                headers: {
                    'Authorization': 'Basic ' + credentials,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            })
            .then(response => response.json())
            .then(resp => {
                window.location = resp.result.uri;
            })
            .catch(error => {
                console.error('Error launching app:', error);
            });
        }

        function displayPatients(fhirData){
            const patientList = document.getElementById('patientList');
            patientList.style.display = 'block';

            const patientsUl = document.getElementById('patients');
            patientsUl.innerHTML = '';

            if(fhirData && fhirData.entry){
                fhirData.entry.forEach(function(entry){
                    const patient = entry.resource;
                    let name = 'Unknown';
                    let id = patient.id;
                    if(patient.name && patient.name.length > 0){
                        const nameObj = patient.name[0];
                        const given = nameObj.given ? nameObj.given.join(' ') : '';
                        const family = nameObj.family || '';
                        const birthDate = patient.birthDate || '';
                        name = `${given} ${family} (${birthDate})`;
                    }
                    const li = document.createElement('li');
                    li.innerHTML = `${name} <span style="color: blue; cursor: pointer;" onclick="launch('${id}')">Launch Growth Chart App</span>`;
                    patientsUl.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'No patients found.';
                patientsUl.appendChild(li);
            }
        }
    </script>
</body>
</html>
