# Python SDK Example


This example shows how to use the [fhir-py client](https://github.com/beda-software/fhir-py "fhir-py") with an Aidbox instance, demonstrating the Python SDK client in action.

Here, we provide several options for using the fhir-py SDK, including basic usage and advanced typing features. The examples start with the simplest solution, which does not include typings, and incrementally incorporate features related to typings.



## Setting up Aidbox Instance

Let's run an Aidbox instance on your computer. 

``` shell
cp .env.tpt .env
# manually add license to .env
docker compose up
```



## Using fhir-py Client with Raw Data

#### Installation

Create new python project and add fhir-py client to your dependencies

``` shell
poetry add fhirpy@2.0.15
```

*Note that this example uses `SyncFHIRClient`. However, you can also use `AsyncFHIRClient``. For more details, refer to the [fhir-py's documentation](https://github.com/beda-software/fhir-py/README.md)*

#### Example 

This is a basic example demonstrating the creation of a new patient. Refer to the example files in each section for more detailed examples.

``` python
from fhirpy import SyncFHIRClient

# create FHIR client instance
client = SyncFHIRClient(
    url="http://localhost:8888/", 
    authorization="Basic cm9vdDpzZWNyZXQ="
)

# create patient resource
patient = client.resource(
    "Patient",
    name=[
        {
            "given": ["Sam"],
            "family": "Brown",
        }
    ],
    gender="male",
)

# save patient resource
patient.save()
```

#### Detailed example

For a more detailed example of how to use fhir-py client with raw data, including working code snippets, check out the [fhirpy_raw_data.py](fhirpy_raw_data.py)



## Option 1. Write Custom Data Models for fhir-py Client

Fhir-py client allows you to write and use [custom data models](https://github.com/beda-software/fhir-py?tab=readme-ov-file#data-models). The following example demonstrates how custom data models can be defined and used in your project. 

This option is offered primarily for educational purposes, to showcase possibilities and improve general understanding. However, we discourage using this method for manually defining data models, as it is both error-prone and cumbersome.

#### Requirements

Data model classes need to meet two requirements:

- Be iterable
- Implement ResourceProtocol interface 

#### Example


``` python
from dataclasses import dataclass, field, asdict
from typing import Optional

from fhirpy import SyncFHIRClient
from fhirpy.base.resource_protocol import ResourceProtocol

# create FHIR client instance
client = SyncFHIRClient(
    url="http://localhost:8888/", 
		authorization="Basic cm9vdDpzZWNyZXQ="
    dump_resource=asdict
)

@dataclass
class Base(ResourceProtocol, dict):
    id: Optional[str] = None
    meta: Optional[Meta] = None

@dataclass
class Patient(Base):
    resourceType: str = "Patient"
    active: Optional[bool] = None
    gender: Optional[str] = None

# create patient resource
patient = Patient(active=True, gender="unknown")

# save patient resource
client.save(patient)
```

#### Detailed example

For a more detailed example of how to write custom data models and use them in fhir-py client, check out the [fhirpy_custom_models.py](fhirpy_custom_models.py) 



## Option 2. Using fhir-py-types

In this example, we demonstrate how to use data models generated by [fhir-py-types generator](https://github.com/beda-software/fhir-py-types "fhir-py-types"), which simplifies working with data models by providing ready-to-use, pre-defined structures aligned with FHIR specifications.

The simplest option to get pre-defined data models is install ready-to-use `fhirpy-types-r4b` or `fhirpy-types-r5` data model sets from PyPi.

#### Installation

``` shell 
poetry add fhirpy-types-r4b@0.1.1
```

#### Example 

``` python
from pydantic import BaseModel
from fhirpy import SyncFHIRClient
from fhirpy_types_r4b import HumanName, Patient

# create FHIR client instance
client = SyncFHIRClient(
    url="http://localhost:8888/", 
    authorization="Basic cm9vdDpzZWNyZXQ=",
    dump_resource=BaseModel.model_dump
)

# create patient resource
patient = Patient(
    name=[
      HumanName(
        given=["Sam"], 
        family="Brown")
    ],
    gender="unknown"
)

# save patient resource
client.save(patient)
```

#### Detailed example

For a more detailed example of how to use `fhirpy-types-r4b` in fhir-py client, check out the [fhirpy_fhirtypes.py](fhirpy_fhirtypes.py)



## Option 3. Using Types Generated by fhir-schema-codegen

Another option for obtaining ready-to-use data models aligned with FHIR specification is to use data models generated by [fhir-schema-codegen](https://github.com/fhir-schema/fhir-schema-codegen).

At the first step you'll need to install generator

```shell
# install fhir-schema-codegen
npm install -g @fhirschema/codegen
```

 Then use it for generating python classes.

```sh
# generate FHIR data models
fscg generate --generator python --output generated --package hl7.fhir.r4.core:4.0.1 
```

After running the generation command, you'll see a new `generated` directory that contains the data models.

#### Example


``` python
from typing import List, Optional

from pydantic import BaseModel
from fhirpy import SyncFHIRClient

from utils import read_csv_as_dict, now
from generated.patient import Patient, HumanName

# create FHIR client instance
client = SyncFHIRClient(
    url="http://localhost:8888/",
    authorization="Basic cm9vdDpzZWNyZXQ=",
    dump_resource=BaseModel.model_dump
)

# create patient resource
patient = Patient(
    name=[
        HumanName(
            given=["Sam"],
            family="Brown"
        )
    ],
    gender="unknown"
)

# save patient resource 
client.create(patient)
```

#### Detailed Example

For a more detailed example of how to use `fhir-schema-codegen` generated data models in fhir-py client, check out the [fhirpy_fhir_schema_codegen.py](fhirpy_fhir_schema_codegen.py)