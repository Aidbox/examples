<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example EHR</title>
</head>

<body>
  <!-- Any third party application -->
  <div
    style="display: flex; background-color: #d9d9d9; position: absolute; top: 0; left: 0; width: 100vw; height: 100px;">
    <span id="user-name"></span>
    <div id="cnt-login">
      <input id="login-uid" type="text" placeholder="Your user id" />
      <button onClick="javascript:onLogin()">Log in</button>
    </div>
    <div id="notifications-container" style="margin-left: auto; width: 700px; height: 700px;"></div>
    <div>
      <button id="cnt-logout" onClick="javascript:onLogout()">Log out</button>
    </div>
  </div>

  <div style="margin-top: 100px;">
    <h1>Example EHR</h1>
    <p>Blah-blah-blah, i'm a supa ugly as f*** EHR!</p>
  </div>

  <script>
    async function loginAidbox(username, password) {
      const AIDBOX_URL = 'http://localhost:8080'

      try {
        const response = await fetch(`${AIDBOX_URL}/auth/token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            grant_type: 'password',
            client_id: 'ehr-outpatient', // Practitioner
            client_secret: 'verysecret',
            username,
            password
          })
        });

        if (!response.ok) {
          throw new Error(`Login failed: ${response.statusText}`);
        }

        return response.json()
      } catch (e) {
        return null
      }
    }

    const setAuthState = (id, name) => {
      document.getElementById('user-name').innerText = id ? `User: ${name}` : ''
      document.getElementById('cnt-login').style.display = id ? 'none' : null
      document.getElementById('cnt-logout').style.display = id ? null : 'none'
      document.getElementById('login-uid').value = ''
    }

    async function loginUser(uid, pwd) {
      const loginData = await loginAidbox(uid, pwd)
      if (loginData) {
        const token = loginData.access_token
        const practitionerId = loginData.userinfo.data?.practitioner?.id
        if (SmartAppLaunchSubscriptions) {
          SmartAppLaunchSubscriptions.setUser(practitionerId)
        }
        setAuthState(loginData.userinfo.id, loginData.userinfo.email)
      }
    }

    function onLogout() {
      if (SmartAppLaunchSubscriptions) {
        SmartAppLaunchSubscriptions.setUser(null)
      }
      setAuthState(null)
    }

    function onLogin() {
      const uid = document.getElementById('login-uid').value
      const pwd = document.getElementById('login-pwd').value

    }

    setTimeout(() => {
      loginUser('house@example.com', 'securepassword')
    }, 500)
  </script>




  <!-- Smart App Integration -->
  <script src="./smart-app-launch.subscriptions.umd.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (SmartAppLaunchSubscriptions && typeof SmartAppLaunchSubscriptions.init === 'function') {
        SmartAppLaunchSubscriptions.init('notifications-container', {
          apiKey: 'http://localhost:9000'
        })
      } else {
        console.error('SmartAppLaunchSubscriptions is not defined')
      }
    })
  </script>
</body>

</html>